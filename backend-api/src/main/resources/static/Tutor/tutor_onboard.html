<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Duet — Tutor Onboarding</title>
    <link rel="stylesheet" href="/styles.css">
  </head>
  <body>
    <header class="top-nav simple">
      <div class="nav-container">
        <div class="brand">DUET</div>
      </div>
    </header>

    <main class="container">
      <section style="max-width:820px;margin:48px auto">
        <h1 style="font-size:2.5rem;color:#5b21b6;margin-bottom:12px">Welcome — Create your tutor profile</h1>
        <p style="font-size:1.1rem;color:#6b7280;margin-bottom:32px;line-height:1.6">Finish setting up your tutor profile so students can find you.</p>
        <form id="onboard-form">
          <!-- Photo Section -->
          <div style="display:flex;gap:32px;align-items:flex-start;margin-bottom:40px;padding:32px;background:rgba(124,58,237,0.04);border-radius:16px;border:1px solid rgba(91,33,182,0.08)">
            <div style="flex-shrink:0">
              <div style="width:180px;height:180px;border-radius:12px;overflow:hidden;background:#f5f5f6;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(91,33,182,0.12)">
                <img id="photoPreview" src="/assets/empty-pfp.svg" alt="Profile photo" style="width:100%;height:100%;object-fit:cover;display:block">
              </div>
              <div style="margin-top:16px">
                <label class="btn-primary" for="inputPhoto" style="display:inline-block;cursor:pointer;text-align:center;width:100%">Choose photo</label>
                <input id="inputPhoto" type="file" accept="image/*" style="display:none">
              </div>
            </div>
            <div style="flex:1">
              <label style="display:block;margin-bottom:12px">
                <span style="display:block;font-weight:700;font-size:1.05rem;color:#0f172a;margin-bottom:8px">Short bio</span>
                <textarea name="bio" id="bio" rows="7" placeholder="Introduce yourself, instruments, styles, experience..." style="width:100%;padding:14px;border-radius:10px;border:1px solid rgba(15,23,42,0.12);background:#fff;font-size:1rem;font-family:inherit;box-shadow:0 4px 12px rgba(11,15,34,0.04)"></textarea>
              </label>
            </div>
          </div>

          <!-- Hourly Rate -->
          <label style="display:block;margin-bottom:24px">
            <span style="display:block;font-weight:700;font-size:1.05rem;color:#0f172a;margin-bottom:8px">Hourly rate (USD)</span>
            <input type="number" id="hourlyRate" name="hourlyRate" step="0.5" min="0" required style="width:100%;max-width:240px;padding:14px;border-radius:10px;border:1px solid rgba(15,23,42,0.12);background:#fff;font-size:1rem;box-shadow:0 4px 12px rgba(11,15,34,0.04)">
          </label>

          <!-- Lesson Type Checkboxes -->
          <div style="margin-bottom:24px;padding:20px;background:rgba(124,58,237,0.04);border-radius:12px;border:1px solid rgba(91,33,182,0.08)">
            <span style="display:block;font-weight:700;font-size:1.05rem;color:#0f172a;margin-bottom:16px">Lesson preferences</span>
            <div style="display:flex;gap:24px;flex-wrap:wrap">
              <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:1rem">
                <input type="checkbox" id="onlineEnabled" style="width:20px;height:20px;cursor:pointer">
                <span>Online lessons</span>
              </label>
              <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:1rem">
                <input type="checkbox" id="inPersonEnabled" style="width:20px;height:20px;cursor:pointer">
                <span>In-person lessons</span>
              </label>
            </div>
          </div>

          <!-- Location -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px">
            <label style="display:block">
              <span style="display:block;font-weight:700;font-size:1.05rem;color:#0f172a;margin-bottom:8px">City</span>
              <input type="text" id="city" name="city" style="width:100%;padding:14px;border-radius:10px;border:1px solid rgba(15,23,42,0.12);background:#fff;font-size:1rem;box-shadow:0 4px 12px rgba(11,15,34,0.04)">
            </label>
            <label style="display:block">
              <span style="display:block;font-weight:700;font-size:1.05rem;color:#0f172a;margin-bottom:8px">State</span>
              <input type="text" id="state" name="state" style="width:100%;padding:14px;border-radius:10px;border:1px solid rgba(15,23,42,0.12);background:#fff;font-size:1rem;box-shadow:0 4px 12px rgba(11,15,34,0.04)">
            </label>
          </div>

          <!-- Timezone -->
          <label style="display:block;margin-bottom:24px">
            <span style="display:block;font-weight:700;font-size:1.05rem;color:#0f172a;margin-bottom:8px">Timezone (e.g. America/New_York)</span>
            <input type="text" id="timezone" name="timezone" style="width:100%;padding:14px;border-radius:10px;border:1px solid rgba(15,23,42,0.12);background:#fff;font-size:1rem;box-shadow:0 4px 12px rgba(11,15,34,0.04)">
          </label>

          <!-- Cancellation Note -->
          <label style="display:block;margin-bottom:32px">
            <span style="display:block;font-weight:700;font-size:1.05rem;color:#0f172a;margin-bottom:8px">Cancellation note (optional)</span>
            <input type="text" id="cancellationNote" name="cancellationNote" placeholder="Your cancellation policy" style="width:100%;padding:14px;border-radius:10px;border:1px solid rgba(15,23,42,0.12);background:#fff;font-size:1rem;box-shadow:0 4px 12px rgba(11,15,34,0.04)">
          </label>

          <!-- Actions -->
          <div style="display:flex;gap:12px;align-items:center">
            <button type="submit" class="btn-primary" style="padding:14px 24px;font-size:1.05rem">Create profile</button>
            <a class="btn-link" href="/Tutor/tutor_home.html" style="padding:14px 24px;font-size:1.05rem">Skip for now</a>
          </div>
        </form>
        <div id="msg" style="margin-top:20px;color:#b00;font-size:1.05rem;font-weight:600"></div>
      </section>
    </main>

  <script>
  (function(){
    function requireUserId(){
      try{ return localStorage.getItem('userId'); }catch(e){ return null; }
    }

    const form = document.getElementById('onboard-form');
    const msg = document.getElementById('msg');
    const fileInput = document.getElementById('inputPhoto');
    let uploadedPhotoUrl = null;
    if(!form) return;

    if (fileInput) {
      fileInput.addEventListener('change', async function(){
        const f = fileInput.files && fileInput.files[0];
        if (!f) return;
        const userId = requireUserId();
        if (!userId) { msg.textContent = 'Please log in first'; return; }
        msg.textContent = 'Uploading...';
        try {
          const fd = new FormData(); fd.append('file', f);
          const upRes = await fetch('/api/tutor-profiles/' + encodeURIComponent(userId) + '/photo', { method: 'POST', body: fd });
          if (upRes.ok) {
            const data = await upRes.json();
            uploadedPhotoUrl = data.photoUrl;
            document.getElementById('photoPreview').src = uploadedPhotoUrl;
            msg.textContent = 'Uploaded.';
          } else {
            const t = await upRes.text(); msg.textContent = 'Upload failed: ' + upRes.status + ' ' + t;
          }
        } catch (err) { console.error(err); msg.textContent = 'Upload failed'; }
      });
    }

    form.addEventListener('submit', async function(e){
      e.preventDefault();
      msg.textContent = '';
      const userId = requireUserId();
      if(!userId){
        msg.textContent = 'No user id found in local storage. Please log in first.';
        setTimeout(()=>{ window.location.href = '/Tutor/tutor_login.html'; }, 1200);
        return;
      }
      let photoUrl = uploadedPhotoUrl || document.getElementById('photoPreview').src || null;
      if (photoUrl && photoUrl.endsWith('/assets/empty-pfp.svg')) photoUrl = null;
      const bio = document.getElementById('bio').value || null;
      const hourly = document.getElementById('hourlyRate').value;
      const hourlyRateCents = (hourly && !isNaN(hourly)) ? Math.round(parseFloat(hourly) * 100) : null;
      const onlineEnabled = document.getElementById('onlineEnabled').checked;
      const inPersonEnabled = document.getElementById('inPersonEnabled').checked;
      const city = document.getElementById('city').value || null;
      const state = document.getElementById('state').value || null;
      const timezone = document.getElementById('timezone').value || null;
      const cancellationNote = document.getElementById('cancellationNote').value || null;

      const payload = {
        photoUrl, bio, hourlyRateCents, onlineEnabled, inPersonEnabled, city, state, timezone, cancellationNote
      };

      if (!uploadedPhotoUrl && fileInput && fileInput.files && fileInput.files[0]){
        try {
          const fd = new FormData(); fd.append('file', fileInput.files[0]);
          const upRes = await fetch('/api/tutor-profiles/' + encodeURIComponent(userId) + '/photo', { method: 'POST', body: fd });
          if (upRes.ok){
            const data = await upRes.json(); photoUrl = data.photoUrl; payload.photoUrl = photoUrl;
            document.getElementById('photoPreview').src = photoUrl;
          } else {
            const t = await upRes.text(); msg.textContent = 'Upload failed: ' + (upRes.status + ' ' + t); return;
          }
        } catch (err) { console.error(err); msg.textContent = 'Upload failed'; return; }
      }

      try{
        const res = await fetch('/api/tutor-profiles/' + encodeURIComponent(userId), {
          method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        if(res.ok){
          window.location.href = '/Tutor/tutor_profile.html';
        } else if(res.status === 409){
          msg.textContent = 'A profile already exists for this account. Redirecting...';
          setTimeout(()=> window.location.href = '/Tutor/tutor_profile.html', 1000);
        } else if(res.status === 400){
          const body = await res.text();
          msg.textContent = 'Bad request: ' + body;
        } else if(res.status === 404){
          msg.textContent = 'User not found. Please log in again.';
        } else {
          msg.textContent = 'Error creating profile: ' + res.status;
        }
      }catch(err){
        console.error(err); msg.textContent = 'Network error';
      }
    });
  })();
  </script>

  </body>
</html>
