<!doctype html>
<html lang="en">
<head>
  <link rel="stylesheet" href="../styles.css">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Calendar — DUET</title>
  <meta name="description" content="Lesson calendar for students">
</head>
<body>
  <header class="top-nav" role="banner">
    <div class="nav-container">
      <div class="brand">DUET</div>
      <div class="search" role="search">
        <form action="search.html" method="get" class="search-inner">
          <label for="nav-search" class="visually-hidden">Search</label>
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
            <circle cx="10.5" cy="10.5" r="5.5" stroke="currentColor" stroke-width="2" fill="none"></circle>
          </svg>
          <input id="nav-search" type="search" name="q" placeholder="Search" />
        </form>
      </div>
      <nav class="nav-links" aria-label="Main navigation">
        <a href="student-home.html" class="nav-link" aria-label="Home">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M3 11.5L12 4l9 7.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
            <path d="M5 21V12h14v9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
          </svg>
        </a>
        <a href="student-message.html" class="nav-link" aria-label="Messages">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
          </svg>
        </a>
        <a href="student-notifications.html" class="nav-link" aria-label="Notifications">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M15 17H9a3 3 0 0 1-3-3V11a6 6 0 1 1 12 0v3a3 3 0 0 1-3 3z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
          </svg>
        </a>
        <a href="student-calendar.html" class="nav-link" aria-label="Calendar">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <rect x="3" y="5" width="18" height="16" rx="2" ry="2" stroke="currentColor" stroke-width="1.6" fill="none"></rect>
            <path d="M16 3v4M8 3v4M3 11h18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
          </svg>
        </a>
        <a href="student-profile.html" class="nav-link" aria-label="Profile">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
            <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="1.6" fill="none"></circle>
          </svg>
        </a>
      </nav>
    </div>
  </header>

  <!-- Calendar -->
  <main class="profile-page">
    <div class="card center-card">
      <div class="calendar-header">
        <h1 id="calendarTitle">Loading...</h1>
        <div class="calendar-controls">
          <a class="btn" href="#" onclick="changeMonth(-1); return false;">◀</a>
          <a class="btn" href="#" onclick="goToToday(); return false;">Today</a>
          <a class="btn" href="#" onclick="changeMonth(1); return false;">▶</a>
        </div>
      </div>

      <div class="cal-weekdays small muted">
        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
      </div>

      <div class="cal-grid" id="calendarGrid">
        <div class="cal-day"><span class="num">Loading...</span></div>
      </div>

      <div class="card day-detail">
        <h2 id="dayDetailTitle">Lessons</h2>
        <ul class="day-list" id="dayDetailList">
          <li>Loading lessons...</li>
        </ul>
      </div>
    </div>
  </main>

  <script>
    const API_BASE_URL = '/api';
    let currentUserId = null;
    let allLessons = [];
    let currentDate = new Date();
    let selectedDate = new Date();

    document.addEventListener('DOMContentLoaded', () => {
      // Get logged-in user ID from localStorage
      currentUserId = localStorage.getItem('userId');
      
      if (!currentUserId) {
        alert('Please log in to continue');
        window.location.href = '/index.html';
        return;
      }

      fetchLessons();
    });

    async function fetchLessons() {
      try {
        const response = await fetch(`${API_BASE_URL}/lessons`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const allLessonsData = await response.json();
        
        // Filter to only show lessons where current user is the student
        allLessons = allLessonsData.filter(lesson => 
          lesson.student.id === parseInt(currentUserId)
        );

        renderCalendar();
        renderDayDetail();
      } catch (error) {
        console.error('Error fetching lessons:', error);
        document.getElementById('dayDetailList').innerHTML = 
          '<li style="color: #d32f2f;">Unable to load lessons.</li>';
      }
    }

    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      // Update title
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                         'July', 'August', 'September', 'October', 'November', 'December'];
      document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;

      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();

      // Get previous month's last days
      const prevMonthLastDay = new Date(year, month, 0).getDate();

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';

      // Add previous month's trailing days
      for (let i = startingDayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        const cell = createDayCell(day, true);
        grid.appendChild(cell);
      }

      // Add current month's days
      const today = new Date();
      const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const isToday = isCurrentMonth && today.getDate() === day;
        const lessonCount = getLessonsForDate(date).length;
        
        const cell = createDayCell(day, false, isToday, lessonCount, date);
        grid.appendChild(cell);
      }

      // Add next month's leading days to fill the grid
      const totalCells = grid.children.length;
      const remainingCells = 35 - totalCells; // 5 weeks = 35 cells
      for (let day = 1; day <= remainingCells; day++) {
        const cell = createDayCell(day, true);
        grid.appendChild(cell);
      }
    }

    function createDayCell(day, isMuted, isToday = false, lessonCount = 0, date = null) {
      const cell = document.createElement('div');
      cell.className = 'cal-day';
      if (isMuted) cell.classList.add('is-muted');
      if (isToday) cell.classList.add('today');
      
      const num = document.createElement('span');
      num.className = 'num';
      num.textContent = day;
      cell.appendChild(num);

      if (lessonCount > 0) {
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = lessonCount;
        cell.appendChild(badge);
      }

      if (date && !isMuted) {
        cell.style.cursor = 'pointer';
        cell.onclick = () => {
          selectedDate = date;
          renderDayDetail();
        };
      }

      return cell;
    }

    function getLessonsForDate(date) {
      const dateStr = date.toISOString().split('T')[0];
      return allLessons.filter(lesson => {
        const lessonDate = new Date(lesson.startUtc).toISOString().split('T')[0];
        return lessonDate === dateStr;
      });
    }

    function renderDayDetail() {
      const lessons = getLessonsForDate(selectedDate);
      const isToday = selectedDate.toDateString() === new Date().toDateString();
      
      document.getElementById('dayDetailTitle').textContent = 
        isToday ? 'Lessons — Today' : `Lessons — ${selectedDate.toLocaleDateString()}`;

      const list = document.getElementById('dayDetailList');
      
      if (lessons.length === 0) {
        list.innerHTML = '<li style="color: #999;">No lessons scheduled for this day.</li>';
        return;
      }

      list.innerHTML = lessons.map(lesson => {
        const start = new Date(lesson.startUtc);
        const end = new Date(lesson.endUtc);
        const startTime = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const endTime = end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const tutor = lesson.tutor.name;
        const mode = lesson.lessonMode === 'ONLINE' ? 'Online' : 'In-Person';
        const status = lesson.status.toLowerCase().replace('_', ' ');
        
        return `
          <li>
            <strong>${startTime}–${endTime}</strong> • 
            Lesson with ${tutor} (${mode})
            <span class="muted small"> — ${status}</span>
          </li>
        `;
      }).join('');
    }

    function changeMonth(delta) {
      currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + delta, 1);
      renderCalendar();
    }

    function goToToday() {
      currentDate = new Date();
      selectedDate = new Date();
      renderCalendar();
      renderDayDetail();
    }
  </script>
</body>
</html>
