<!doctype html>
<html lang="en">

<head>
  <link rel="stylesheet" href="../styles.css">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Student Dashboard ‚Äî DUET</title>
  <meta name="description" content="Student dashboard for DUET music tutor platform">
</head>

<body>
  <header class="top-nav" role="banner">
    <div class="nav-container">
      <div class="brand">DUET</div>
      <div class="search" role="search">
        <form onsubmit="handleSearch(event)" class="search-inner">
          <label for="nav-search" class="visually-hidden">Search</label>
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" fill="none"></path>
            <circle cx="10.5" cy="10.5" r="5.5" stroke="currentColor" stroke-width="2" fill="none"></circle>
          </svg>
          <input id="nav-search" type="search" name="q" placeholder="Search" />
        </form>
      </div>
      <nav class="nav-links" aria-label="Main navigation">
        <a href="student-home.html" class="nav-link" aria-label="Home">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M3 11.5L12 4l9 7.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
              stroke-linejoin="round" fill="none"></path>
            <path d="M5 21V12h14v9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
              stroke-linejoin="round" fill="none"></path>
          </svg>
        </a>
        <a href="student-message.html" class="nav-link" aria-label="Messages">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor"
              stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
          </svg>
        </a>
        <a href="student-notifications.html" class="nav-link" aria-label="Notifications">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M15 17H9a3 3 0 0 1-3-3V11a6 6 0 1 1 12 0v3a3 3 0 0 1-3 3z" stroke="currentColor" stroke-width="1.6"
              stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
              stroke-linejoin="round" fill="none"></path>
          </svg>
        </a>
        <a href="student-calendar.html" class="nav-link" aria-label="Calendar">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <rect x="3" y="5" width="18" height="16" rx="2" ry="2" stroke="currentColor" stroke-width="1.6" fill="none">
            </rect>
            <path d="M16 3v4M8 3v4M3 11h18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
              stroke-linejoin="round" fill="none"></path>
          </svg>
        </a>
        <a href="student-profile.html" class="nav-link" aria-label="Profile">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="1.6"
              stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
            <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="1.6" fill="none"></circle>
          </svg>
        </a>
      </nav>
    </div>
  </header>

  <main>
    <section class="dashboard">
      <header class="dashboard-header">
        <h1>Dashboard</h1>
        <p class="muted">Overview of available tutors</p>
      </header>

      <div class="dashboard-grid">
        <div class="col-left">
          <section class="card upcoming-tutors" aria-labelledby="upcoming-tutors-title">
            <h2 id="upcoming-tutors-title">Tutors</h2>
            <ul class="tutors-grid">
            </ul>
          </section>
        </div>

        <div class="col-right">
          <section class="card" aria-label="Location Filter">
            <h3>Find Nearest Tutors</h3>
            <div style="margin-bottom: 10px;">
              <label for="student-zip" style="display: block; margin-bottom: 5px; font-weight: 500;">Enter Zipcode</label>
              <input type="text" id="student-zip" placeholder="e.g. 27412" 
                style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd; font-size: 14px;" />
            </div>
            <button class="btn primary" id="apply-location" style="width: 100%;">Find Nearest</button>
          </section>

          <section class="card" aria-labelledby="upcoming-lessons-title">
            <h2 id="upcoming-lessons-title">Upcoming Lessons</h2>
            <ul id="upcomingLessonsList" style="list-style: none; padding: 0;">
              <li style="padding: 10px; color: #999;">Loading lessons...</li>
            </ul>
          </section>

          <section class="card stats" aria-label="Student stats">
            <div class="stat-grid">
              <div>
                <h4>Tutors available</h4>
                <div class="stat-value">9</div>
              </div>
              <div>
                <h4>Tutors filtered</h4>
                <div class="stat-value">9</div>
              </div>
              <div>
                <h4>Avg. hr rate</h4>
                <div class="stat-value">$40</div>
              </div>
            </div>
          </section>
        </div>
      </div>

      <footer class="dashboard-footer muted small">
        Tip: Use filters to find tutors that match your learning style and goals.
      </footer>
    </section>
  </main>

  <!-- Schedule Lesson Modal -->
  <div id="scheduleModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" onclick="closeScheduleModal()">&times;</span>
      <h2>Schedule a Lesson</h2>
      <form id="scheduleForm" onsubmit="submitScheduleLesson(event)">
        <input type="hidden" id="modalTutorId" />

        <div class="form-group">
          <label for="instrumentSelect">Instrument *</label>
          <select id="instrumentSelect" required>
            <option value="">Select an instrument...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="levelSelect">Skill Level *</label>
          <select id="levelSelect" required>
            <option value="BEGINNER">Beginner</option>
            <option value="INTERMEDIATE">Intermediate</option>
            <option value="ADVANCED">Advanced</option>
            <option value="EXPERT">Expert</option>
          </select>
        </div>

        <div class="form-group">
          <label for="durationInput">Duration (minutes) *</label>
          <select id="durationInput" required>
            <option value="30">30 minutes</option>
            <option value="45">45 minutes</option>
            <option value="60" selected>60 minutes</option>
            <option value="90">90 minutes</option>
            <option value="120">120 minutes</option>
          </select>
        </div>

        <div class="form-group">
          <label for="dateTimeInput">Preferred Date & Time *</label>
          <input type="datetime-local" id="dateTimeInput" required />
        </div>

        <div class="form-group">
          <label for="lessonModeSelect">Lesson Mode *</label>
          <select id="lessonModeSelect" required>
            <option value="ONLINE">Online</option>
            <option value="IN_PERSON">In-Person</option>
          </select>
        </div>

        <div class="form-group">
          <label for="notesInput">Notes (Optional)</label>
          <textarea id="notesInput" rows="4"
            placeholder="Any special requests or topics you'd like to focus on..."></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn" onclick="closeScheduleModal()">Cancel</button>
          <button type="submit" class="btn primary">Submit Request</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow: auto;
    }

    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      position: relative;
    }

    .close {
      position: absolute;
      right: 20px;
      top: 20px;
      font-size: 28px;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
    }

    .close:hover {
      color: #000;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 30px;
    }

    .success-message,
    .error-message {
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .success-message {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>

  <script>
    const API_BASE_URL = '/api';

    let allTutors = [];
    let filteredTutors = [];
    let allInstruments = [];
    let currentUserId = null;
    let filters = {
      instrument: null,
      levels: [],
      availability: [],
      priceRange: null,
      zip: null,
      zipLat: null,
      zipLon: null
    };

    document.addEventListener('DOMContentLoaded', () => {
      // Get logged-in user ID from localStorage
      currentUserId = localStorage.getItem('userId');

      if (!currentUserId) {
        // Redirect to login if not authenticated
        alert('Please log in to continue');
        window.location.href = '/index.html';
        return;
      }

      fetchTutors();
      fetchInstruments();
      fetchUpcomingLessons();
      setupFilterListeners();
      setMinDateTime();
      
      // Check if there's a search query from redirect
      const searchQuery = sessionStorage.getItem('searchQuery');
      if (searchQuery) {
        document.getElementById('nav-search').value = searchQuery;
        sessionStorage.removeItem('searchQuery'); // Clear it after using
        // Trigger search after tutors are loaded
        setTimeout(() => {
          handleSearch({ preventDefault: () => {} });
        }, 500);
      }
    });

    function setMinDateTime() {
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('dateTimeInput').min = now.toISOString().slice(0, 16);
    }

    async function fetchInstruments() {
      try {
        const response = await fetch(`${API_BASE_URL}/instruments`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        allInstruments = await response.json();
        populateInstrumentSelect();
      } catch (error) {
        console.error('Error fetching instruments:', error);
      }
    }

    function populateInstrumentSelect() {
      const select = document.getElementById('instrumentSelect');
      allInstruments.forEach(instrument => {
        const option = document.createElement('option');
        option.value = instrument.id;
        option.textContent = instrument.name;
        select.appendChild(option);
      });
    }

    async function fetchTutors() {
      try {
        const response = await fetch(`${API_BASE_URL}/tutors/search`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        allTutors = await response.json();
        filteredTutors = [...allTutors];
        renderTutors();
        updateStats();
      } catch (error) {
        console.error('Error fetching tutors:', error);
        showError('Unable to load tutors. Please try again later.');
      }
    }

    function renderTutors() {
      const tutorsContainer = document.querySelector('.tutors-grid');

      if (filteredTutors.length === 0) {
        tutorsContainer.innerHTML = '<li class="no-results">No tutors found matching your criteria.</li>';
        return;
      }

      tutorsContainer.innerHTML = filteredTutors.map(tutor => `
        <li>
          <img class="tutor-photo" src="${tutor.photoUrl || 'empty-pfp.jpg'}" alt="Photo of ${tutor.user.name}" />
          <h3 class="tutor-name">${tutor.user.name}</h3>
          <p class="tutor-bio">${tutor.bio || 'No bio available.'}</p>
          <div class="tutor-meta">
            <div class="meta-row">
              <span class="meta-label">Rate</span>
              <div class="chips">
                <span class="chip">$${(tutor.hourlyRateCents / 100).toFixed(2)}/hr</span>
              </div>
            </div>
            <div class="meta-row">
              <span class="meta-label">Location</span>
              <div class="chips">
                ${tutor.city && tutor.state ? `<span class="chip">${tutor.city}, ${tutor.state}</span>` : '<span class="chip">Location not specified</span>'}
              </div>
            </div>
            <div class="meta-row">
              <span class="meta-label">Mode</span>
              <div class="chips">
                ${tutor.onlineEnabled ? '<span class="chip">Online</span>' : ''}
                ${tutor.inPersonEnabled ? '<span class="chip">In-Person</span>' : ''}
              </div>
            </div>
            ${tutor.ratingCount > 0 ? `
            <div class="meta-row">
              <span class="meta-label">Rating</span>
              <div class="chips">
                <span class="chip"> ${tutor.ratingAvg.toFixed(1)} (${tutor.ratingCount} reviews)</span>
              </div>
            </div>
            ` : ''}
          </div>
          <div class="actions-row">
            <a class="btn primary" href="#" onclick="scheduleLesson(${tutor.userId}); return false;">Schedule Lesson</a>
            <a class="btn" href="#" onclick="messageTutor(${tutor.userId}); return false;">Message Tutor</a>
            <a class="btn" href="#" onclick="createOffer(${tutor.userId}); return false;">Create Offer</a>
          </div>
        </li>
      `).join('');
    }

    function updateStats() {
      const totalTutors = allTutors.length;
      const filteredCount = filteredTutors.length;
      const avgRate = filteredTutors.length > 0
        ? filteredTutors.reduce((sum, t) => sum + t.hourlyRateCents, 0) / filteredTutors.length / 100
        : 0;

      document.querySelector('.stat-grid').innerHTML = `
        <div>
          <h4>Tutors available</h4>
          <div class="stat-value">${totalTutors}</div>
        </div>
        <div>
          <h4>Tutors filtered</h4>
          <div class="stat-value">${filteredCount}</div>
        </div>
        <div>
          <h4>Avg. hr rate</h4>
          <div class="stat-value">$${avgRate.toFixed(0)}</div>
        </div>
      `;
    }

    function setupFilterListeners() {
      document.querySelectorAll('.filters .meta-row:nth-child(1) .chip').forEach(chip => {
        chip.addEventListener('click', function () {
          document.querySelectorAll('.filters .meta-row:nth-child(1) .chip').forEach(c => {
            c.classList.remove('active');
            c.setAttribute('aria-pressed', 'false');
          });
          this.classList.add('active');
          this.setAttribute('aria-pressed', 'true');

          filters.instrument = this.textContent.trim();
          applyFilters();
        });
      });

      document.querySelectorAll('.filters .meta-row:nth-child(2) .chip').forEach(chip => {
        chip.addEventListener('click', function () {
          this.classList.toggle('active');
          const isActive = this.classList.contains('active');
          this.setAttribute('aria-pressed', isActive);

          const level = this.textContent.trim();
          if (isActive) {
            filters.levels.push(level);
          } else {
            filters.levels = filters.levels.filter(l => l !== level);
          }
          applyFilters();
        });
      });

      document.querySelectorAll('.filters .meta-row:nth-child(3) .chip').forEach(chip => {
        chip.addEventListener('click', function () {
          this.classList.toggle('active');
          const isActive = this.classList.contains('active');
          this.setAttribute('aria-pressed', isActive);

          const avail = this.textContent.trim();
          if (isActive) {
            filters.availability.push(avail);
          } else {
            filters.availability = filters.availability.filter(a => a !== avail);
          }
          applyFilters();
        });
      });

      document.querySelectorAll('.filters .meta-row:nth-child(4) .chip').forEach(chip => {
        chip.addEventListener('click', function () {
          document.querySelectorAll('.filters .meta-row:nth-child(4) .chip').forEach(c => {
            c.classList.remove('active');
            c.setAttribute('aria-pressed', 'false');
          });
          this.classList.add('active');
          this.setAttribute('aria-pressed', 'true');

          filters.priceRange = this.textContent.trim();
          applyFilters();
        });
      });

      // Setup location filter button
      const btnLoc = document.getElementById('apply-location');
      if (btnLoc) {
        btnLoc.addEventListener('click', async () => {
          const zip = (document.getElementById('student-zip')?.value || '').trim();
          if (!zip) {
            alert('Please enter a zipcode');
            return;
          }
          try {
            const {lat, lon} = await geocodeZip(zip);
            filters.zip = zip;
            filters.zipLat = lat;
            filters.zipLon = lon;
            applyFilters();
          } catch(e) {
            alert('Could not resolve zipcode. Please check and try again.');
          }
        });
      }
    }

    async function geocodeZip(zip) {
      const res = await fetch(`https://api.zippopotam.us/us/${encodeURIComponent(zip)}`);
      if (!res.ok) throw new Error('Invalid zipcode');
      const data = await res.json();
      const place = data.places && data.places[0];
      return { lat: parseFloat(place.latitude), lon: parseFloat(place.longitude) };
    }

    function toRad(x) {
      return x * Math.PI / 180;
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 3958.8; // Earth radius in miles
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    function applyFilters() {
      filteredTutors = allTutors.filter(tutor => {
        if (filters.priceRange) {
          const rate = tutor.hourlyRateCents / 100;
          if (filters.priceRange === '$' && rate > 30) return false;
          if (filters.priceRange === '$$' && (rate <= 30 || rate > 60)) return false;
          if (filters.priceRange === '$$$' && rate <= 60) return false;
        }

        return true;
      });

      // Sort by distance if zipcode filter is applied
      if (filters.zipLat != null && filters.zipLon != null) {
        filteredTutors = filteredTutors.map(t => {
          const hasGeo = t.latitude != null && t.longitude != null;
          const dist = hasGeo ? haversine(filters.zipLat, filters.zipLon, t.latitude, t.longitude) : Number.POSITIVE_INFINITY;
          return {...t, _distanceMi: dist};
        }).sort((a, b) => (a._distanceMi || Infinity) - (b._distanceMi || Infinity));
      }

      renderTutors();
      updateStats();
      updateFooter();
    }

    function updateFooter() {
      const footer = document.querySelector('.dashboard-footer');
      const activeFilters = [];

      if (filters.instrument) activeFilters.push(filters.instrument);
      if (filters.levels.length > 0) activeFilters.push(...filters.levels);
      if (filters.priceRange) activeFilters.push(filters.priceRange);
      if (filters.zip) activeFilters.push(`ZIP ${filters.zip}`);
      
      if (activeFilters.length === 0) {
        footer.textContent = 'Tip: Use filters to find tutors that match your learning style and goals.';
      } else {
        footer.textContent = `Showing tutors filtered by: ${activeFilters.join(', ')}. Adjust filters to see more results.`;
      }
    }

    function scheduleLesson(tutorId) {
      document.getElementById('modalTutorId').value = tutorId;
      document.getElementById('scheduleModal').style.display = 'block';
    }

    function closeScheduleModal() {
      document.getElementById('scheduleModal').style.display = 'none';
      document.getElementById('scheduleForm').reset();
      // Remove any success/error messages
      const messages = document.querySelectorAll('.success-message, .error-message');
      messages.forEach(msg => msg.remove());
    }

    async function submitScheduleLesson(event) {
      event.preventDefault();

      const formData = {
        studentId: parseInt(currentUserId),
        tutorId: parseInt(document.getElementById('modalTutorId').value),
        instrumentId: parseInt(document.getElementById('instrumentSelect').value),
        level: document.getElementById('levelSelect').value,
        durationMin: parseInt(document.getElementById('durationInput').value),
        requestedStartUtc: new Date(document.getElementById('dateTimeInput').value).toISOString(),
        lessonMode: document.getElementById('lessonModeSelect').value,
        notes: document.getElementById('notesInput').value || null
      };

      try {
        const response = await fetch(`${API_BASE_URL}/booking-requests`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Failed to create booking request: ${errorText}`);
        }

        const bookingRequest = await response.json();

        // Show success message
        const form = document.getElementById('scheduleForm');
        const successMsg = document.createElement('div');
        successMsg.className = 'success-message';
        successMsg.textContent = `Lesson request submitted successfully! The tutor will review your request. Booking ID: ${bookingRequest.id}`;
        form.insertBefore(successMsg, form.firstChild);

        // Reset form after 2 seconds and close modal
        setTimeout(() => {
          closeScheduleModal();
        }, 2000);

      } catch (error) {
        console.error('Error creating booking request:', error);

        // Show error message
        const form = document.getElementById('scheduleForm');
        const errorMsg = document.createElement('div');
        errorMsg.className = 'error-message';
        errorMsg.textContent = `Error: ${error.message}`;
        form.insertBefore(errorMsg, form.firstChild);
      }
    }

    function messageTutor(tutorId) {
      alert(`Message tutor ID: ${tutorId}`);
      // TODO: Implement messaging functionality
    }

    function createOffer(tutorId) {
      alert(`Create offer for tutor ID: ${tutorId}`);
      // TODO: Implement offer creation functionality
    }

    function showError(message) {
      const tutorsContainer = document.querySelector('.tutors-grid');
      tutorsContainer.innerHTML = `<li class="error-message" style="color: #d32f2f; padding: 20px; text-align: center;">${message}</li>`;
    }

    async function fetchUpcomingLessons() {
      try {
        const response = await fetch(`${API_BASE_URL}/lessons`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const allLessons = await response.json();
        
        // Filter to only show lessons where current user is the student
        const myLessons = allLessons.filter(lesson => 
          lesson.student.id === parseInt(currentUserId)
        );

        // Filter for upcoming lessons (future dates only)
        const now = new Date();
        const upcomingLessons = myLessons
          .filter(lesson => new Date(lesson.startUtc) > now)
          .sort((a, b) => new Date(a.startUtc) - new Date(b.startUtc))
          .slice(0, 5); // Show only next 5 lessons

        renderUpcomingLessons(upcomingLessons);
      } catch (error) {
        console.error('Error fetching upcoming lessons:', error);
        document.getElementById('upcomingLessonsList').innerHTML = 
          '<li style="padding: 10px; color: #d32f2f;">Unable to load lessons.</li>';
      }
    }

    function renderUpcomingLessons(lessons) {
      const listContainer = document.getElementById('upcomingLessonsList');
      
      if (lessons.length === 0) {
        listContainer.innerHTML = '<li style="padding: 10px; color: #999;">No upcoming lessons scheduled.</li>';
        return;
      }

      listContainer.innerHTML = lessons.map(lesson => {
        const start = new Date(lesson.startUtc);
        const end = new Date(lesson.endUtc);
        const date = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const startTime = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const endTime = end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const tutor = lesson.tutor.name;
        const mode = lesson.lessonMode === 'ONLINE' ? 'üåê Online' : 'üìç In-Person';
        
        return `
          <li style="padding: 12px; border-bottom: 1px solid #eee;">
            <div style="font-weight: 500; margin-bottom: 4px;">${tutor}</div>
            <div style="font-size: 0.9em; color: #666;">
              ${date} ‚Ä¢ ${startTime}‚Äì${endTime}
            </div>
            <div style="font-size: 0.85em; color: #888; margin-top: 4px;">
              ${mode}
            </div>
          </li>
        `;
      }).join('');
    }

    function handleSearch(event) {
      event.preventDefault();
      
      const searchQuery = document.getElementById('nav-search').value.toLowerCase().trim();
      
      if (!searchQuery) {
        // If search is empty, show all tutors
        filteredTutors = [...allTutors];
      } else {
        // Filter tutors by name, bio, city, or state
        filteredTutors = allTutors.filter(tutor => {
          const name = tutor.user.name.toLowerCase();
          const bio = (tutor.bio || '').toLowerCase();
          const city = (tutor.city || '').toLowerCase();
          const state = (tutor.state || '').toLowerCase();
          
          return name.includes(searchQuery) || 
                 bio.includes(searchQuery) || 
                 city.includes(searchQuery) || 
                 state.includes(searchQuery);
        });
      }
      
      renderTutors();
      updateStats();
    }

    // Close modal when clicking outside of it
    window.onclick = function (event) {
      const modal = document.getElementById('scheduleModal');
      if (event.target === modal) {
        closeScheduleModal();
      }
    }
  </script>
</body>

</html>