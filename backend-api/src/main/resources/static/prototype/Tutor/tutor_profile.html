<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Profile — DUET</title>
  <link rel="stylesheet" href="../styles.css">
</head>
<body>
  <header class="top-nav" role="banner">
    <div class="nav-container">
      <div class="brand">DUET</div>
      <div class="search" role="search">
        <label for="nav-search" class="visually-hidden">Search</label>
        <div class="search-inner">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
            <circle cx="10.5" cy="10.5" r="5.5" stroke="currentColor" stroke-width="2" fill="none"></circle>
          </svg>
          <input id="nav-search" type="search" placeholder="Search" />
        </div>
      </div>
      <nav class="nav-links" aria-label="Main navigation">
        <a href="tutor_home.html" class="nav-link" aria-label="Home">Home</a>
        <a href="tutor-message.html" class="nav-link" aria-label="Messages">Msgs</a>
        <a href="tutor-notifications.html" class="nav-link" aria-label="Notifications">Notifs</a>
        <a href="tutor-calendar.html" class="nav-link" aria-label="Calendar">Cal</a>
        <a href="tutor_profile.html" class="nav-link" aria-label="Profile">Profile</a>
      </nav>
    </div>
  </header>

  <main class="profile-page">
    <div class="profile-view-card card center-card" id="profileView">
      <button class="edit-toggle" id="editToggle" aria-label="Edit profile">✎</button>
      <h1>Your profile</h1>
      <div class="view-top">
        <div class="photo-large">
          <img id="viewPhoto" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect%20fill='%23f3f4f6'%20width='100%25'%20height='100%25'/%3E%3Ctext%20x='50%25'%20y='50%25'%20dominant-baseline='middle'%20text-anchor='middle'%20fill='%23666'%20font-size='14'%20font-family='Arial,Helvetica'%3ENo%20Photo%3C/text%3E%3C/svg%3E" alt="Profile photo">
        </div>
        <div class="view-main">
          <div class="view-row"><span class="label">Display name</span><span class="value" id="viewName">Emma Tutor</span></div>
          <div class="view-row"><span class="label">Bio</span><span class="value" id="viewBio">Enthusiastic piano teacher with 8 years of experience teaching all ages.</span></div>
          <div class="view-row"><span class="label">Instruments</span><span class="value" id="viewInstruments">Piano, Keyboard</span></div>
          <div class="view-row"><span class="label">Levels</span><span class="value" id="viewLevels">Beginner, Intermediate</span></div>
        </div>
      </div>
      <div class="view-grid">
        <div class="view-row"><span class="label">Genres</span><span class="value" id="viewGenres">Classical, Pop</span></div>
        <div class="view-row"><span class="label">Credentials</span><span class="value" id="viewCreds">B.M. in Piano Performance</span></div>
        <div class="view-row"><span class="label">Hourly rate (local)</span><span class="value" id="viewRateLocal">$40</span></div>
        <div class="view-row"><span class="label">Hourly rate (online)</span><span class="value" id="viewRateOnline">$30</span></div>
        <div class="view-row"><span class="label">Travel radius</span><span class="value" id="viewRadius">10 miles</span></div>
        <div class="view-row"><span class="label">Studio address</span><span class="value" id="viewAddress">123 Music Ave, City, ZIP</span></div>
        <div class="view-row"><span class="label">Lesson types</span><span class="value" id="viewTypes">Online, In-person at studio</span></div>
        <div class="view-row"><span class="label">Cancellation policy</span><span class="value" id="viewCancel">24-hour notice (full refund)</span></div>
        <div class="view-row"><span class="label">Prep buffer</span><span class="value" id="viewPrep">10 minutes</span></div>
        <div class="view-row"><span class="label">Commute buffer</span><span class="value" id="viewCommute">20 minutes</span></div>
      </div>
    </div>

    <div class="profile-edit-card card center-card hidden" id="profileEdit">
      <button class="edit-toggle" id="cancelEdit" aria-label="Cancel editing">✕</button>
      <h1>Edit profile</h1>
      <form class="profile-form" id="editForm">
        <div class="edit-top">
          <div class="photo-large edit-photo">
            <input id="inputPhoto" type="file" accept="image/*">
            <img id="editPhotoPreview" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect%20fill='%23f3f4f6'%20width='100%25'%20height='100%25'/%3E%3Ctext%20x='50%25'%20y='50%25'%20dominant-baseline='middle'%20text-anchor='middle'%20fill='%23666'%20font-size='14'%20font-family='Arial,Helvetica'%3ENo%20Photo%3C/text%3E%3C/svg%3E" alt="Profile photo">
          </div>
          <div class="edit-main">
            <label class="field"><span>Display name</span><input id="inputName" type="text" value="Emma Tutor"></label>
            <label class="field"><span>Bio</span><textarea id="inputBio">Enthusiastic piano teacher with 8 years of experience teaching all ages.</textarea></label>
            <label class="field"><span>Instruments</span><input id="inputInstruments" type="text" value="Piano, Keyboard"></label>
            <label class="field"><span>Levels</span><input id="inputLevels" type="text" value="Beginner, Intermediate"></label>
          </div>
        </div>
        <div class="edit-grid">
          <label class="field"><span>Genres</span><input id="inputGenres" type="text" value="Classical, Pop"></label>
          <label class="field"><span>Credentials</span><textarea id="inputCreds">B.M. in Piano Performance</textarea></label>
          <label class="field"><span>Hourly rate (local)</span><input id="inputRateLocal" type="number" value="40"></label>
          <label class="field"><span>Hourly rate (online)</span><input id="inputRateOnline" type="number" value="30"></label>
          <label class="field"><span>Travel radius (miles)</span><input id="inputRadius" type="number" value="10"></label>
          <label class="field"><span>Studio address</span><input id="inputAddress" type="text" value="123 Music Ave, City, ZIP"></label>
          <label class="field"><span>Lesson types</span><input id="inputTypes" type="text" value="Online, In-person at studio"></label>
          <label class="field"><span>Cancellation policy</span><select id="inputCancel"><option>24-hour notice (full refund)</option><option>12-hour notice (50% refund)</option><option>Strict (no refund)</option></select></label>
          <label class="field"><span>Prep buffer (minutes)</span><input id="inputPrep" type="number" value="10"></label>
          <label class="field"><span>Commute buffer (minutes)</span><input id="inputCommute" type="number" value="20"></label>
        </div>
        <div class="form-actions">
          <button class="btn primary" id="saveBtn" type="button">Save</button>
          <button class="btn" id="resetBtn" type="button">Reset</button>
        </div>
      </form>
    </div>
  </main>
  <script>
    const API_BASE = '/api';
    const editToggle = document.getElementById('editToggle');
    const profileView = document.getElementById('profileView');
    const profileEdit = document.getElementById('profileEdit');
    const cancelEdit = document.getElementById('cancelEdit');
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');

    function requireLogin() {
      const uid = localStorage.getItem('userId');
      if (!uid) {
        window.location.href = 'tutor_login.html';
        return null;
      }
      return uid;
    }

    function showEdit(){
      profileView.classList.add('hidden');
      profileEdit.classList.remove('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function showView(){
      profileEdit.classList.add('hidden');
      profileView.classList.remove('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    }

    editToggle && editToggle.addEventListener('click', showEdit);
    cancelEdit && cancelEdit.addEventListener('click', showView);

    function populateView(p) {
      document.getElementById('viewPhoto').src = p.photoUrl || document.getElementById('viewPhoto').src;
      document.getElementById('viewName').textContent = p.user?.name || '';
      document.getElementById('viewBio').textContent = p.bio || '';
      document.getElementById('viewRateLocal').textContent = p.hourlyRateCents ? '$' + (p.hourlyRateCents/100) : '';
      document.getElementById('viewRateOnline').textContent = p.hourlyRateCents ? '$' + (p.hourlyRateCents/100) : '';
      document.getElementById('viewAddress').textContent = p.city ? p.city + (p.state ? (', ' + p.state) : '') : '';
      document.getElementById('viewCancel').textContent = p.cancellationNote || '';
      document.getElementById('inputPhoto') && (document.getElementById('editPhotoPreview').src = p.photoUrl || document.getElementById('editPhotoPreview').src);
      document.getElementById('inputName').value = p.user?.name || '';
      document.getElementById('inputBio').value = p.bio || '';
      document.getElementById('inputRateLocal').value = p.hourlyRateCents ? (p.hourlyRateCents/100) : '';
      document.getElementById('inputRateOnline').value = p.hourlyRateCents ? (p.hourlyRateCents/100) : '';
      document.getElementById('inputAddress').value = p.city ? p.city + (p.state ? (', ' + p.state) : '') : '';
      document.getElementById('inputCancel').value = p.cancellationNote || '';
      document.getElementById('inputPrep') && (document.getElementById('inputPrep').value = '');
    }

    async function loadProfile() {
      const uid = requireLogin(); if (!uid) return;
      try {
        const res = await fetch(`${API_BASE}/tutor-profiles/${uid}`);
        if (res.ok) {
          const profile = await res.json();
          populateView(profile);
        } else if (res.status === 404) {
          const userRes = await fetch(`${API_BASE}/users/${uid}`);
          if (userRes.ok) {
            const user = await userRes.json();
            populateView({ user, hourlyRateCents: 0 });
          }
        } else {
          console.error('Failed loading profile', res.status);
        }
      } catch (e) { console.error(e); }
    }

    saveBtn && saveBtn.addEventListener('click', async ()=>{
      const uid = requireLogin(); if (!uid) return;
      const payload = {
        bio: document.getElementById('inputBio').value,
        photoUrl: document.getElementById('editPhotoPreview').src,
        hourlyRateCents: Math.round(parseFloat(document.getElementById('inputRateLocal').value || '0') * 100),
        city: document.getElementById('inputAddress').value,
        cancellationNote: document.getElementById('inputCancel').value,
        onlineEnabled: true,
        inPersonEnabled: true
      };
      try {
        const res = await fetch(`${API_BASE}/tutor-profiles/${uid}`, {
          method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        if (res.ok) {
          const updated = await res.json();
          populateView(updated);
          showView();
        } else {
          alert('Failed to save: ' + res.status);
        }
      } catch (e) { console.error(e); alert('Save failed'); }
    });

    resetBtn && resetBtn.addEventListener('click', ()=>{
      loadProfile();
    });

    loadProfile();
  </script>
</body>
</html>
