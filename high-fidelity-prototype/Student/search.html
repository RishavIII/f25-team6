<!doctype html>
<html lang="en">

<head>
  <link rel="stylesheet" href="../styles.css">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Search Results â€” DUET</title>
  <meta name="description" content="Search results page filtered for Piano tutors">
</head>

<body>
  <header class="top-nav" role="banner">
    <div class="nav-container">
      <div class="brand">DUET</div>
      <div class="search" role="search">
        <form action="search.html" method="get" class="search-inner">
          <label for="nav-search" class="visually-hidden">Search</label>
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" fill="none"></path>
            <circle cx="10.5" cy="10.5" r="5.5" stroke="currentColor" stroke-width="2" fill="none"></circle>
          </svg>
          <input id="nav-search" type="search" name="q" placeholder="Search" />
        </form>
      </div>
      <nav class="nav-links" aria-label="Main navigation">
        <a href="student-home.html" class="nav-link" aria-label="Home">
          <!-- home icon -->
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M3 11.5L12 4l9 7.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
              stroke-linejoin="round" fill="none"></path>
            <path d="M5 21V12h14v9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
              stroke-linejoin="round" fill="none"></path>
          </svg>
        </a>
        <a href="student-message.html" class="nav-link" aria-label="Messages">
          <!-- messages icon -->
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
              stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
              stroke-linejoin="round" fill="none"></path>
          </svg>
        </a>
        <a href="student-notifications.html" class="nav-link" aria-label="Notifications">
          <!-- notifications icon -->
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M15 17H9a3 3 0 0 1-3-3V11a6 6 0 1 1 12 0v3a3 3 0 0 1-3 3z"
              stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
              stroke-linejoin="round" fill="none"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"
              stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
              stroke-linejoin="round" fill="none"></path>
          </svg>
        </a>
        <a href="student-calendar.html" class="nav-link" aria-label="Calendar">
          <!-- calendar icon -->
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <rect x="3" y="5" width="18" height="16" rx="2" ry="2"
              stroke="currentColor" stroke-width="1.6" fill="none"></rect>
            <path d="M16 3v4M8 3v4M3 11h18"
              stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
              stroke-linejoin="round" fill="none"></path>
          </svg>
        </a>
        <a href="student-profile.html" class="nav-link" aria-label="Profile">
          <!-- profile icon -->
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"
              stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
              stroke-linejoin="round" fill="none"></path>
            <circle cx="12" cy="7" r="4"
              stroke="currentColor" stroke-width="1.6" fill="none"></circle>
          </svg>
        </a>
      </nav>
    </div>
  </header>

  <main>
    <section class="dashboard">
      <header class="dashboard-header">
        <h1>Search Results</h1>
        <p class="muted">Filtered by instrument: Piano</p>
      </header>

      <div class="dashboard-grid">
        <div class="col-left">
          <section class="card upcoming-tutors" aria-labelledby="results-tutors-title">
            <h2 id="results-tutors-title">Tutors</h2>
            <ul class="tutors-grid">
            </ul>
          </section>
        </div>

        <div class="col-right">

          <section class="card stats" aria-label="Search stats">
            <div class="stat-grid">
              <div>
                <h4>Tutors available</h4>
                <div class="stat-value">9</div>
              </div>
              <div>
                <h4>Tutors filtered</h4>
                <div class="stat-value">1</div>
              </div>
              <div>
                <h4>Avg. hr rate</h4>
                <div class="stat-value">$40</div>
              </div>
            </div>
          </section>
        </div>
      </div>

      <footer class="dashboard-footer muted small">
        Showing Piano tutors only. Adjust filters to see more results.
      </footer>
    </section>
  </main>

  <script>
  const API_BASE_URL = 'http://localhost:8080/api';

  let allTutors = [];
  let filteredTutors = [];
  let filters = {
    instrument: null,
    levels: [],
    availability: [],
    priceRange: null,
    searchText: '' 
  };

  document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const q = params.get('q');
    if (q) {
      filters.searchText = q.toLowerCase();
      const input = document.getElementById('nav-search');
      if (input) input.value = q;
    }

    fetchTutors();
    setupFilterListeners();
  });

  async function fetchTutors() {
    try {
      const response = await fetch(`${API_BASE_URL}/tutors/search`);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      allTutors = await response.json();

      applyFilters();
    } catch (error) {
      console.error('Error fetching tutors:', error);
      showError('Unable to load tutors. Please try again later.');
    }
  }

  function renderTutors() {
    const tutorsContainer = document.querySelector('.tutors-grid');

    if (filteredTutors.length === 0) {
      tutorsContainer.innerHTML =
        '<li class="no-results">No tutors found matching your criteria.</li>';
      return;
    }

    tutorsContainer.innerHTML = filteredTutors.map(tutor => `
      <li>
        <img class="tutor-photo"
             src="${tutor.photoUrl || 'empty-pfp.jpg'}"
             alt="Photo of ${tutor.user?.name || 'Tutor'}" />

        <h3 class="tutor-name">${tutor.user?.name || 'Unknown Tutor'}</h3>
        <p class="tutor-bio">${tutor.bio || 'No bio available.'}</p>

        <div class="tutor-meta">
          <div class="meta-row">
            <span class="meta-label">Rate</span>
            <div class="chips">
              <span class="chip">$${(tutor.hourlyRateCents / 100).toFixed(2)}/hr</span>
            </div>
          </div>

          <div class="meta-row">
            <span class="meta-label">Location</span>
            <div class="chips">
              ${tutor.city && tutor.state
                ? `<span class="chip">${tutor.city}, ${tutor.state}</span>`
                : '<span class="chip">Location not specified</span>'}
            </div>
          </div>

          <div class="meta-row">
            <span class="meta-label">Mode</span>
            <div class="chips">
              ${tutor.onlineEnabled ? '<span class="chip">Online</span>' : ''}
              ${tutor.inPersonEnabled ? '<span class="chip">In-Person</span>' : ''}
            </div>
          </div>

          ${tutor.ratingCount > 0 ? `
          <div class="meta-row">
            <span class="meta-label">Rating</span>
            <div class="chips">
              <span class="chip">
                ${tutor.ratingAvg.toFixed(1)} (${tutor.ratingCount} reviews)
              </span>
            </div>
          </div>
          ` : ''}
        </div>

        <div class="actions-row">
          <a class="btn primary" href="#" onclick="scheduleLesson(${tutor.userId}); return false;">Schedule Lesson</a>
          <a class="btn" href="#" onclick="messageTutor(${tutor.userId}); return false;">Message Tutor</a>
          <a class="btn" href="#" onclick="createOffer(${tutor.userId}); return false;">Create Offer</a>
        </div>
      </li>
    `).join('');
  }

  function updateStats() {
    const totalTutors = allTutors.length;
    const filteredCount = filteredTutors.length;
    const avgRate = filteredTutors.length > 0
      ? filteredTutors.reduce((sum, t) => sum + t.hourlyRateCents, 0) / filteredTutors.length / 100
      : 0;

    document.querySelector('.stat-grid').innerHTML = `
      <div>
        <h4>Tutors available</h4>
        <div class="stat-value">${totalTutors}</div>
      </div>
      <div>
        <h4>Tutors filtered</h4>
        <div class="stat-value">${filteredCount}</div>
      </div>
      <div>
        <h4>Avg. hr rate</h4>
        <div class="stat-value">$${avgRate.toFixed(0)}</div>
      </div>
    `;
  }

  function setupFilterListeners() {
    document.querySelectorAll('.filters .meta-row:nth-child(4) .chip').forEach(chip => {
      chip.addEventListener('click', function() {
        document.querySelectorAll('.filters .meta-row:nth-child(4) .chip').forEach(c => {
          c.classList.remove('active');
          c.setAttribute('aria-pressed', 'false');
        });
        this.classList.add('active');
        this.setAttribute('aria-pressed', 'true');

        filters.priceRange = this.textContent.trim();
        applyFilters();
      });
    });
  }

  function applyFilters() {
    filteredTutors = allTutors.filter(tutor => {
      if (filters.searchText) {
        const q = filters.searchText;

        const name = (tutor.user?.name || '').toLowerCase();
        const city = (tutor.city || '').toLowerCase();
        const state = (tutor.state || '').toLowerCase();
        const bio = (tutor.bio || '').toLowerCase();

        const haystack = `${name} ${city} ${state} ${bio}`;

        if (!haystack.includes(q)) return false;
      }

      if (filters.priceRange) {
        const rate = tutor.hourlyRateCents / 100;
        if (filters.priceRange === '$' && rate > 30) return false;
        if (filters.priceRange === '$$' && (rate <= 30 || rate > 60)) return false;
        if (filters.priceRange === '$$$' && rate <= 60) return false;
      }

      return true;
    });

    renderTutors();
    updateStats();
    updateFooter();
  }

  function updateFooter() {
    const footer = document.querySelector('.dashboard-footer');
    const activeFilters = [];

    if (filters.searchText) activeFilters.push(`"${filters.searchText}"`);
    if (filters.priceRange) activeFilters.push(filters.priceRange);

    if (activeFilters.length === 0) {
      footer.textContent = 'Showing all tutors. Use filters to narrow your search.';
    } else {
      footer.textContent = `Showing tutors filtered by: ${activeFilters.join(', ')}.`;
    }
  }

  function scheduleLesson(tutorId) { alert(`Schedule lesson with tutor ID: ${tutorId}`); }
  function messageTutor(tutorId) { alert(`Message tutor ID: ${tutorId}`); }
  function createOffer(tutorId) { alert(`Create offer for tutor ID: ${tutorId}`); }

  function showError(message) {
    const tutorsContainer = document.querySelector('.tutors-grid');
    tutorsContainer.innerHTML =
      `<li class="error-message" style="color:#d32f2f;padding:20px;text-align:center;">${message}</li>`;
  }
</script>

</body>

</html>
