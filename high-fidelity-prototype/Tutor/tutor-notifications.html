<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Notifications â€” DUET</title>
  <link rel="stylesheet" href="../styles.css">
</head>

<body>
  <header class="top-nav" role="banner">
    <div class="nav-container">
      <div class="brand">DUET</div>

      <nav class="nav-links" aria-label="Main navigation">
        <a href="tutor_home.html" class="nav-link" aria-label="Home">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M3 11.5L12 4l9 7.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
              stroke-linejoin="round" fill="none"></path>
            <path d="M5 21V12h14v9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
              stroke-linejoin="round" fill="none"></path>
          </svg>
        </a>
        <a href="tutor-message.html" class="nav-link" aria-label="Messages">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor"
              stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
          </svg>
        </a>
        <a href="tutor-notifications.html" class="nav-link" aria-label="Notifications">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M15 17H9a3 3 0 0 1-3-3V11a6 6 0 1 1 12 0v3a3 3 0 0 1-3 3z" stroke="currentColor" stroke-width="1.6"
              stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
              stroke-linejoin="round" fill="none"></path>
          </svg>
        </a>
        <a href="tutor-calendar.html" class="nav-link" aria-label="Calendar">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <rect x="3" y="5" width="18" height="16" rx="2" ry="2" stroke="currentColor" stroke-width="1.6" fill="none">
            </rect>
            <path d="M16 3v4M8 3v4M3 11h18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
              stroke-linejoin="round" fill="none"></path>
          </svg>
        </a>
        <a href="tutor_profile.html" class="nav-link" aria-label="Profile">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="1.6"
              stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
            <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="1.6" fill="none"></circle>
          </svg>
        </a>
      </nav>
    </div>
  </header>

  <!-- Notifications content -->
  <main class="profile-page">
    <div class="card center-card">
      <h1>Notifications</h1>

      <div class="filters-row">
        <button class="chip chip-active" aria-pressed="true">All</button>
        <button class="chip" aria-pressed="false">Unread</button>
        <span class="muted small">3 unread</span>
      </div>

      <ul class="notifications-list" id="notifList">
        <!-- Dynamic Content -->
      </ul>

      <div class="actions-row">
        <a class="btn" href="#">Mark all as read</a>
      </div>
    </div>
  </main>
  <script>
    const API_BASE = 'http://localhost:8080/api';
    const uid = localStorage.getItem('userId');

    async function handleBooking(id, status) {
      if (!confirm('Are you sure you want to ' + status.toLowerCase() + ' this request?')) return;
      try {
        const res = await fetch(`${API_BASE}/booking-requests/${id}/${status.toLowerCase()}`, { method: 'POST' });
        if (res.ok) {
          loadNotifs(); // reload
        } else {
          alert('Action failed');
        }
      } catch (e) { console.error(e); }
    }

    async function loadNotifs() {
      if (!uid) return;
      try {
        const res = await fetch(`${API_BASE}/tutors/${uid}/notifications`);
        if (res.ok) {
          const list = await res.json();
          const ul = document.getElementById('notifList');
          ul.innerHTML = list.map(n => {
            let actions = '';
            if (n.type === 'booking') {
              actions = `
                <div class="notif-actions" style="margin-top:0.5rem">
                  <button class="btn small" onclick="handleBooking(${n.id}, 'ACCEPT')">Accept</button>
                  <button class="btn small secondary" onclick="handleBooking(${n.id}, 'DECLINE')">Decline</button>
                </div>
              `;
            } else if (n.type === 'message') {
              actions = `
                <div class="notif-actions" style="margin-top:0.5rem">
                  <a class="btn small secondary" href="tutor-message.html?convId=${n.conversationId}">View Message</a>
                </div>
              `;
            }

            return `
            <li class="notif-item ${!n.read ? 'is-unread' : ''}">
              <div class="notif-dot" aria-hidden="true"></div>
              <div class="notif-body">
                <strong>${n.title}</strong>
                <p>${n.body || ''}</p>
                <span class="time small muted">${new Date(n.createdAt).toLocaleString()}</span>
                ${actions}
              </div>
            </li>
            `;
          }).join('');
        }
      } catch (e) { console.error(e); }
    }
    loadNotifs();
  </script>
</body>

</html>